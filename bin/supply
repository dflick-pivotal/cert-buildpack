#!/bin/bash

set -eu

build_path=$1
cache_path=$2
deps_path=$3
index=$4

echo "cert-buildpack"
echo "##############"
echo "build_path: $build_path"
echo "cache_path: $cache_path"
echo "deps_path: $deps_path"
echo "index: $index"

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`
output_dir=$deps_path/$index/resources/open_jdk_jre/lib/security

echo "-----> Copy Certs"
mkdir -p $output_dir
cp $BUILDPACK_DIR/resources/open_jdk_jre/lib/security/server.crt $output_dir/.

# Create a config.yml 
cat > $deps_path/$index/config.yml << EOF
name: cert-buildpack
version: 0.1
EOF

PROFILED_FOLDER=$deps_path/$index/profile.d
PROFILED_FILE=$PROFILED_FOLDER/profile.d
echo Creating $PROFILED_FILE
mkdir -p $PROFILED_FOLDER

# Create a profile.d file
 
addcert="~/app/.java-buildpack/open_jdk_jre/bin/keytool -import -trustcacerts -keystore ~/app/.java-buildpack/open_jdk_jre/lib/security/cacert -storepass changeit -noprompt -alias daimler -file ~/deps/0/resources/open_jdk_jre/lib/security/server.crt"
#echo $addcert > $PROFILED_FILE 
echo cert-buildpack complete

